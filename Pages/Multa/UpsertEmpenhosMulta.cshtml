@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@model FrotiX.Pages.Multa.UpsertEmpenhosMultaModel

@{
    ViewData["Title"] = "Empenhos dos Orgãos Autuantes";
    ViewData["PageName"] = "multa_empenhosmulta";
    ViewData["Heading"] = "<i class='fad fa-money-check-alt'></i>&nbsp;Cadastros: <span class='fw-300'>Empenhos dos Orgãos Autuantes</span>";
    ViewData["Category1"] = "Multas";
    ViewData["PageIcon"] = "fal fa-money-check-alt";

}

<style>
    .form-control-xs {
        height: calc(1em + .775rem + 2px) !important;
        padding: .125rem .25rem !important;
        font-size: .75rem !important;
        line-height: 1.5;
        border-radius: .2rem;
    }

    .label {
        margin-bottom: -5px;
        margin-top: 10px;
    }
</style>

@section HeadBlock {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
    <link rel="stylesheet" href="~/css/microtip.css" />

}


<form method="post" asp-action="Upsert">
    <div class="row">
        <div class="col-xl-12">
            <div id="panel-1" class="panel">
                <div class="panel-container show">
                    <div class="panel-content">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        @if (Model.EmpenhoMultaObj.EmpenhoMultaId != Guid.Empty)
                        {
                            <input type="hidden" asp-for="EmpenhoMultaObj.EmpenhoMultaId" />
                        }
                        <div class="col-12 px-3" style="border-bottom:1px solid #325d88">
                            <h2 class="text-primary">@(Model.EmpenhoMultaObj.EmpenhoMultaId != Guid.Empty ? "Atualizar " : "Criar ") Empenho do Órgão Autuante  </h2>
                        </div>

                        <div class="col-12 pt-3">

                            <div class="row">
                                <div class="col-4">
                                    <div class="form-group">
                                        <label class="label font-weight-bold" asp-for="EmpenhoMultaObj.EmpenhoMulta.OrgaoAutuanteId"></label>
                                        @*<span class="text-danger font-weight-light" asp-validation-for="EmpenhoMultaObj.EmpenhoMulta.OrgaoAutuanteId"></span>*@
                                        @Html.DropDownListFor(m => m.EmpenhoMultaObj.EmpenhoMulta.OrgaoAutuanteId,
                                                                Model.EmpenhoMultaObj.OrgaoList,
                                                                "-- Selecione um Órgão --",
                                                                new { @class = "form-control form-control-xs", @id = "listaorgao" })
                                    </div>
                                </div>
                                <div class="col-2 col-sm-3">
                                    <div class="form-group">
                                        <label class="label font-weight-bold" asp-for="EmpenhoMultaObj.EmpenhoMulta.NotaEmpenho"></label>
                                        <span class="text-danger  font-weight-light" asp-validation-for="EmpenhoMultaObj.EmpenhoMulta.NotaEmpenho"></span>
                                        <input class="form-control form-control-xs" asp-for="EmpenhoMultaObj.EmpenhoMulta.NotaEmpenho" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-2">
                                    <div class="form-group">
                                        <label class="label font-weight-bold" asp-for="EmpenhoMultaObj.EmpenhoMulta.AnoVigencia"></label>
                                        <span class="text-danger font-weight-light" asp-validation-for="EmpenhoMultaObj.EmpenhoMulta.AnoVigencia"></span>
                                        <select class="form-control form-control-xs" asp-for="EmpenhoMultaObj.EmpenhoMulta.AnoVigencia">
                                            <option value="">-- Ano --</option>
                                            <option value="2023">2025</option>
                                            <option value="2023">2024</option>
                                            <option value="2023">2023</option>
                                            <option value="2022">2022</option>
                                            <option value="2021">2021</option>
                                            <option value="2020">2020</option>
                                            <option value="2019">2019</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-2 col-sm-2">
                                    <div class="form-group">
                                        <label class="label font-weight-bold" asp-for="EmpenhoMultaObj.EmpenhoMulta.SaldoInicial"></label>
                                        <span class="text-danger" asp-validation-for="EmpenhoMultaObj.EmpenhoMulta.SaldoInicial"></span>
                                        <input id="txtSaldoInicial" class="form-control form-control-xs" data-inputmask="'alias': 'currency'" style="text-align: right;" asp-for="EmpenhoMultaObj.EmpenhoMulta.SaldoInicial" onKeyPress="return(moeda(this,'.',',',event))" />
                                    </div>
                                </div>
                                <div class="col-2 col-sm-2">
                                    <div class="form-group">
                                        <label class="label font-weight-bold" asp-for="EmpenhoMultaObj.EmpenhoMulta.SaldoAtual"></label>
                                        <span class="text-danger" asp-validation-for="EmpenhoMultaObj.EmpenhoMulta.SaldoAtual"></span>
                                        <input id="txtSaldoAtual" disabled="disabled" class="form-control form-control-xs" data-inputmask="'alias': 'currency'" style="text-align: right;" asp-for="EmpenhoMultaObj.EmpenhoMulta.SaldoAtual" onKeyPress="return(moeda(this,'.',',',event))" />
                                    </div>
                                </div>
                                <div class="col-2" float="right">
                                    <div class="form-group">
                                        <label class="label font-weight-bold">Multas do Empenho</label>
                                        <input id="txtSaldoMultas" class="form-control form-control-xs campodireita" data-inputmask="'alias': 'currency'" style="text-align: right;" disabled />
                                    </div>
                                </div>
                                <div class="col-1" float="right">
                                    <a class="btn btn-nfs btn-primary btn-xs text-white" data-toggle="modal" data-target="#modalMultas" id="rowdata" aria-label="Multas do Empenho!" data-microtip-position="top" role="tooltip" style="cursor:pointer; margin-top: 32px;" data-id="@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId">
                                        <i class="fal fa-money-check-alt"></i>
                                    </a>
                                </div>
                            </div>

                        </div>

                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="label font-weight-bold">
                                        <input id="chkStatus" type="checkbox" class="form-check-input" asp-for="EmpenhoMultaObj.EmpenhoMulta.Status" />
                                        Ativo/Inativo
                                    </label>
                                </div>
                                <br />
                            </div>
                        </div>

                        <br />
                        <br />

                        <div class="form-group row">
                            <div class="col-12 col-sm-6 col-md-6">
                                <div class="row">
                                    <div class="col-6">
                                        <button type="submit" value="Submit" asp-page-handler="Submit" class="btn btn-primary form-control">@(Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId != Guid.Empty ? "Atualizar" : "Criar")</button>

                                    </div>
                                    <div class="col-6">
                                        <a asp-page="./ListaEmpenhosMulta" class="btn btn-success form-control">Voltar à Lista</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    @if (Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId != Guid.Empty)
                    {
                        <div class="row">
                            <div class="col-6">
                                <div class="panel-content ">
                                    <div class="box-body">
                                        <br />
                                        <h3 id="TituloAportes">Aportes/Reforços ao Empenho</h3>
                                        <br />
                                        <table id="tblAporte" class="table table-bordered table-striped" width="100%">
                                            <thead>
                                                <tr>
                                                    <th>Data Aporte</th>
                                                    <th>Descrição</th>
                                                    <th>Valor</th>
                                                    <th>Ação</th>
                                                    <th>Id</th>
                                                    <th>Valor Original</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="panel-content ">
                                    <div class="box-body">
                                        <br />
                                        <h3 id="TituloAnulacoes">Anulações do Empenho</h3>
                                        <br />
                                        <table id="tblanulacao" class="table table-bordered table-striped" width="100%">
                                            <thead>
                                                <tr>
                                                    <th>Data Anulação</th>
                                                    <th>Descrição</th>
                                                    <th>Valor</th>
                                                    <th>Ação</th>
                                                    <th>Id</th>
                                                    <th>Valor Original</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    </div>
</form>


<!-- Modal Multas -->
<div class="modal fade" id="modalMultas">
    <div class="modal-dialog modal-xl" role="document">

        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title" id="DynamicModalLabel">Multas do Empenho</h4>
            </div>

            <div class="modal-body table-bordered">
                <!-- Dynamic Data is displayed in this part of the modal body -->
                <!-- Modal body id = "modal_body" (note underscore) -->
                <form id="frmMultas">
                    <table id="tblMultas" class="table table-bordered table-striped" width="100%">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Nº Infração</th>
                                <th>Local</th>
                                <th>Data de Pagamento</th>
                                <th>Valor Pago</th>
                                <th>Ação</th>
                                <th>MultaId</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Fechar</button>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
        </div>
    </div>
</div>

<!-- Modal Aportar -->
<div class="modal fade" id="modalAporte">
    <div class="modal-dialog modal-lg" role="document">

        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title" id="DynamicModalLabel">Aportar Valores ao Empenho</h4>
                @*<button type="button" class="close" data-dismiss="modal">&times;<span aria-hidden="true"></span></button>*@
            </div>


            <div class="modal-body table-bordered">
                <!-- Dynamic Data is displayed in this part of the modal body -->
                <!-- Modal body id = "modal_body" (note underscore) -->
                @*<h6 id="modal_body">Corpo do Modal</h6>*@
                <form id="frmAporte">
                    <input type="hidden" id="txtEmpenhoMultaId" />
                    <input type="hidden" id="txtMovimentacaoId" />
                    <div class="row">
                        <div class="col-5">
                            <div class="form-group">
                                <label class="font-weight-bold">Data do Aporte</label>
                                <span class="text-danger"></span>
                                <input id="txtDataAporte" class="form-control form-control-xs" type="date" />
                            </div>
                        </div>
                        <br />
                        <div class="col-7">
                            <div class="form-group">
                                <label class="font-weight-bold">Descrição</label>
                                <span class="text-danger"></span>
                                <input id="txtDescricaoAporte" class="form-control form-control-xs" />
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-3">
                            <div class="form-group">
                                <label class="font-weight-bold">Valor do Aporte</label>
                                <span class="text-danger"></span>
                                <input id="txtValorAporte" class="form-control form-control-xs" data-inputmask="'alias': 'currency'" style="text-align: right;" onKeyPress="return(moeda(this,'.',',',event))" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="btnAportar" class="btn btn-primary" type="submit" value="SUBMIT">Editar Aporte</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Fechar</button>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
        </div>
    </div>
</div>

<!-- Modal anulacao -->
<div class="modal fade" id="modalanulacao">
    <div class="modal-dialog modal-lg" role="document">

        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title" id="DynamicModalLabel">Anular Valores do Empenho</h4>
            </div>

            <div class="modal-body table-bordered">
                <!-- Dynamic Data is displayed in this part of the modal body -->
                <!-- Modal body id = "modal_body" (note underscore) -->
                <form id="frmanulacao">
                    <input type="hidden" id="txtEmpenhoId" />
                    <input type="hidden" id="txtMovimentacaoId" />
                    <div class="row">
                        <div class="col-5">
                            <div class="form-group">
                                <label class="font-weight-bold">Data do Aporte</label>
                                <span class="text-danger"></span>
                                <input id="txtDataanulacao" class="form-control form-control-xs" type="date" />
                            </div>
                        </div>
                        <br />
                        <div class="col-7">
                            <div class="form-group">
                                <label class="font-weight-bold">Descrição</label>
                                <span class="text-danger"></span>
                                <input id="txtDescricaoanulacao" class="form-control form-control-xs" />
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-3">
                            <div class="form-group">
                                <label class="font-weight-bold">Valor do Aporte</label>
                                <span class="text-danger"></span>
                                <input id="txtValoranulacao" class="form-control form-control-xs" data-inputmask="'alias': 'currency'" style="text-align: right;" onKeyPress="return(moeda(this,'.',',',event))" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="btnAnular" class="btn btn-primary" type="submit" value="SUBMIT">Editar Anulação</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Fechar</button>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
        </div>
    </div>
</div>


@section ScriptsBlock
{

    @*<script src="https://code.jquery.com/jquery-3.5.1.js"></script>*@
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

    <script src="~/js/formplugins/select2/select2.bundle.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="~/js/cadastros/aporte.js"></script>
    <script src="~/js/cadastros/anulacao.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.0.min.js"></script>
    <script type="text/javascript" src="js/jquery.tooltipster.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>


    <script>

        var AporteTable;
        var anulacaoTable;
        var Id;

        $(document).ready(function () {

            console.log('@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId');

            if ('@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId' === '00000000-0000-0000-0000-000000000000' || '@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId' === 0 || '@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId' === null) {

                document.getElementById("chkStatus").checked = true;

            }
            else
            {
                $('table.display').dataTable(); //Permite múltiplas datatables em uma só página

                @*$("#txtSaldoInicial").val(Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format('@Model.EmpenhoMultaObj.EmpenhoMulta.SaldoInicial'));
                $("#txtSaldoAtual").val(Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format('@Model.EmpenhoMultaObj.EmpenhoMulta.SaldoAtual'));*@

                //var saldoinicial = $('#txtSaldoInicial').val().replace(",", ".");
                //saldoinicial = Number(saldoinicial);
                //$('#txtSaldoInicial').val(saldoinicial.toLocaleString({ style: "currency", currency: "BRL" }));

                //var saldofinal = $('#txtSaldoAtual').val().replace(",", ".");
                //saldofinal = Number(saldofinal);
                //$('#txtSaldoAtual').val(saldofinal.toLocaleString({ style: "currency", currency: "BRL" }));

                $.ajax({
                    type: "get",
                    url: "/api/Multa/SaldoMultas",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                        data: { Id: '@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId' },

                    success: function (data)
                    {

                        $('#txtSaldoMultas').val(data.saldomultas.toLocaleString({ style: "currency", currency: "BRL" }));

                        var saldoinicial = $('#txtSaldoInicial').val().replace(",", ".");
                        saldoinicial = Number(saldoinicial);
                        $('#txtSaldoInicial').val(saldoinicial.toLocaleString({ style: "currency", currency: "BRL" }));

                        var saldofinal = $('#txtSaldoAtual').val().replace(",", ".");
                        saldofinal = Number(saldofinal);
                        $('#txtSaldoAtual').val(saldofinal.toLocaleString({ style: "currency", currency: "BRL" }));

                    }
                });
            }

            //Configura a Exibição do Modal de Multas
            //=======================================
            $("#modalMultas").modal({
                keyboard: true,
                backdrop: "static",
                show: false,

            }).on("show.bs.modal", function (event) {

                var button = $(event.relatedTarget); // button the triggered modal
                var empenhoMultaId = button.data("id"); //data-id of button which is equal to id (primary key) of person

                var dataTableMultas = $('#tblMultas').DataTable();
                dataTableMultas.destroy();

                dataTableMultas = $('#tblMultas').DataTable({
                    'columnDefs': [
                        {
                            "targets": 0,                //Data
                            "className": "text-center",
                            "width": "5%",
                        },
                        {
                            "targets": 1,                //Multa
                            "className": "text-center",
                            "width": "5%",
                        },
                        {
                            "targets": 2,               //Local Multa
                            "className": "text-right",
                            "width": "50%",
                        },
                        {
                            "targets": 3,               //Data de Pagamento
                            "className": "text-center",
                            "width": "5%",
                        },
                        {
                            "targets": 4,               //Valor Pago
                            "className": "text-right",
                            "width": "5%",
                        },
                        {
                            "targets": 5,               //Ação
                            "className": "text-center",
                            "width": "12%",
                        },
                        {
                            "targets": 6,               //MultaId
                            "className": "text-center",
                            "width": "10%",
                            "visible": false,
                        }
                    ],
                    responsive: true,
                    "ajax": {
                        "url": "/api/multa/multaempenhopagas",
                        "data": { id: empenhoMultaId},
                        "type": "GET",
                        "datatype": "json"
                    },
                    "columns": [
                        { "data": "dataFormatada" },
                        { "data": "numInfracao" },
                        { "data": "localizacao" },
                        { "data": "dataPagamentoFormatada" },
                        { "data": "valorPago" },
                        {
                            "data": "multaId",
                            "render": function (data) {
                                return `<div class="text-center">
                                <a href="/Multa/UpsertPenalidade?id=${data}" class="btn btn-primary btn-xs text-white"  aria-label="Editar a Multa (penalidade)!" data-microtip-position="top" role="tooltip" style="cursor:pointer; margin: 2px">
                                    <i class="far fa-edit"></i>
                                </a>
                                <a class="btn btn-delete btn-danger btn-xs text-white" aria-label="Excluir a Multa!" data-microtip-position="top" role="tooltip" style="cursor:pointer; margin: 2px" data-id='${data}'>
                                    <i class="far fa-trash-alt"></i>
                                </a>
                        </div>`;
                            },
                        },
                        { "data": "multaId" },
                    ],
                    "language": {
                        "url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
                        "emptyTable": "Sem Dados para Exibição"
                    }
                });

            }).on("hide.bs.modal", function (event) {
                $(this).find("#modal_body").html("");
            });


            AporteTable = $('#tblAporte').DataTable({
                "lengthChange": false,
                "searching": false,
                "bSort": false,
                'columnDefs': [
                    {
                        "targets": 0, // Data do Aporte
                        "className": "text-center",
                        "width": "10%"
                    },
                    {
                        "targets": 1, // Descricao
                        "className": "text-left",
                        "width": "15%"
                    },
                    {
                        "targets": 2, // Valor
                        "className": "text-right",
                        "width": "10%"
                    },
                    {
                        "targets": 3, // Ação
                        "className": "text-center",
                        "width": "10%"
                    },
                    {
                        "targets": 4, // MovimentacaoId
                        "className": "text-center",
                        "visible": false
                    },
                    {
                        "targets": 5, // Valor não formatado
                        "className": "text-center",
                        "visible": false
                    }
                ],
                responsive: true,
                "ajax": {
                    "url": "/api/multa/listaaporte",
                    "type": "GET",
                    "datatype": "json",
                    "data": { Id: '@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId' },
                },
                "columns": [
                    { "data": "dataFormatada" },
                    { "data": "descricao" },
                    { "data": "valorFormatado" },
                    {
                        "data": "movimentacaoId",
                        "render": function (data) {
                            return `<div class="text-center">
                                    <a class="btn btn-aporte btn-dark btn-xs text-white" data-toggle="modal" data-target="#modalAporte" id="rowdata" aria-label="Editar Aporte!" data-microtip-position="top" role="tooltip" style="cursor:pointer; margin: 2px" data-id='${data}' data-backdrop="false">
                                        <i class="far fa-edit"></i>
                                    </a>
                                    <a class="btn btn-deleteaporte btn-danger btn-xs text-white" aria-label="Excluir o Aporte!" data-microtip-position="top" role="tooltip" style="cursor:pointer; margin: 2px" data-id='${data}'>
                                        <i class="far fa-trash-alt"></i>
                                    </a>
                        </div>`;
                        },
                    },
                    { "data": "movimentacaoId" },
                    { "data": "valorOriginal" },

                ],
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
                    "emptyTable": "Sem Dados para Exibição"
                },
                "width": "100%",
                "footerCallback": function (row, data, start, end, display) {
                    total = this.api()
                        .column(5)
                        .data()
                        .reduce(function (a, b) {
                            return parseInt(a) + parseInt(b);
                        }, 0);
                    soma = total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
                    $("#TituloAportes").html("Aportes/Reforços do Empenho: " + soma);
                }
            });

            anulacaoTable = $('#tblanulacao').DataTable({
                "lengthChange": false,
                "searching": false,
                "bSort": false,
                'columnDefs': [
                    {
                        "targets": 0, // Data da anulacao
                        "className": "text-center",
                        "width": "10%"
                    },
                    {
                        "targets": 1, // Descricao
                        "className": "text-left",
                        "width": "15%"
                    },
                    {
                        "targets": 2, // Valor
                        "className": "text-right",
                        "width": "10%",
                        "createdCell": function (td, cellData, rowData, row, col)
                            {
                                $(td).css('color', 'red')
                            }
                    },
                    {
                        "targets": 3, // Ação
                        "className": "text-center",
                        "width": "10%"
                    },
                    {
                        "targets": 4, // MovimentacaoId
                        "className": "text-center",
                        "visible": false
                    },
                    {
                        "targets": 5, // Valor não formatado
                        "className": "text-center",
                        "visible": false
                    }
                ],
                responsive: true,
                "ajax": {
                    "url": "/api/multa/listaanulacao",
                    "type": "GET",
                    "data": { Id: '@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId' },
                    "datatype": "json",
                },
                "columns": [
                    { "data": "dataFormatada" },
                    { "data": "descricao" },
                    { "data": "valorFormatado" },
                    {
                        "data": "movimentacaoId",
                        "render": function (data) {
                            return `<div class="text-center">
                                    <a class="btn btn-anulacao btn-dark btn-xs text-white" data-toggle="modal" data-target="#modalanulacao" id="rowdata" aria-label="Editar Anulação!" data-microtip-position="top" role="tooltip" style="cursor:pointer; margin: 2px" data-id='${data}' data-backdrop="false">
                                        <i class="far fa-edit"></i>
                                    </a>
                                    <a class="btn btn-deleteanulacao btn-danger btn-xs text-white" aria-label="Excluir a anulacao!" data-microtip-position="top" role="tooltip" style="cursor:pointer; margin: 2px" data-id='${data}'>
                                        <i class="far fa-trash-alt"></i>
                                    </a>
                        </div>`;
                        },
                    },
                    { "data": "movimentacaoId" },
                    { "data": "valorOriginal" },

                ],
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
                    "emptyTable": "Sem Dados para Exibição"
                },
                "width": "100%",
                "footerCallback": function (row, data, start, end, display) {
                    total = this.api()
                        .column(5)
                        .data()
                        .reduce(function (a, b) {
                            return parseInt(a) + parseInt(b);
                        }, 0);
                    soma = total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
                    $("#TituloAnulacoes").html("Anulações do Empenho: <span>" + soma + "</span>");
                }

            });

            //Configura a Exibição do Modal de Aporte
            //=======================================
            $("#modalAporte").modal({
                keyboard: true,
                backdrop: "static",
                show: false,

            }).on("show.bs.modal", function (event) {

                var button = $(event.relatedTarget); // button the triggered modal
                var movimentacaoId = button.data("id"); //data-id of button which is equal to id (primary key)

                notaEmpenho = $("#txtNotaEmpenho").text();
                console.log($(event.relatedTarget).closest("tr").find("td:eq(0)").text());
                console.log($(event.relatedTarget).closest("tr").find("td:eq(1)").text());
                console.log($(event.relatedTarget).closest("tr").find("td:eq(2)").text());

                var notaEmpenho = $("#txtNotaEmpenho").val();
                var dataAporte = $(event.relatedTarget).closest("tr").find("td:eq(0)").text();
                var descricaoAporte = $(event.relatedTarget).closest("tr").find("td:eq(1)").text();
                var valorAporte = $(event.relatedTarget).closest("tr").find("td:eq(2)").text();


                var parts = dataAporte.split('/');
                dataAporte = parts[2] + "-" + (parts[1]) + "-" + parts[0];
                $("#txtDataAporte").val(dataAporte);

                $("#txtDescricaoAporte").val(descricaoAporte);
                $("#txtValorAporte").val(valorAporte);

                //displays values to modal
                $(this).find("#DynamicModalLabel").html($("<b>Editar Aporte do Empenho: " + notaEmpenho + "</b>"))
                $('#btnAportar').attr('data-id', movimentacaoId);
                $('#txtMovimentacaoId').attr('value', movimentacaoId);
            }).on("hide.bs.modal", function (event) {
                $(this).find("#modal_body").html("");
            });

            //Configura a Exibição do Modal de anulacao
            //======================================
            $("#modalanulacao").modal({
                keyboard: true,
                backdrop: "static",
                show: false,

            }).on("show.bs.modal", function (event) {

                console.log("Entrou na Abertura do Modal");

                var button = $(event.relatedTarget); // button the triggered modal
                var movimentacaoId = button.data("id"); //data-id of button which is equal to id (primary key)

                notaEmpenho = $("#txtNotaEmpenho").text();
                console.log($(event.relatedTarget).closest("tr").find("td:eq(0)").text());
                console.log($(event.relatedTarget).closest("tr").find("td:eq(1)").text());
                console.log($(event.relatedTarget).closest("tr").find("td:eq(2)").text());

                var notaEmpenho = $("#txtNotaEmpenho").val();
                var dataanulacao = $(event.relatedTarget).closest("tr").find("td:eq(0)").text();
                var descricaoanulacao = $(event.relatedTarget).closest("tr").find("td:eq(1)").text();
                var valoranulacao = $(event.relatedTarget).closest("tr").find("td:eq(2)").text();


                var parts = dataanulacao.split('/');
                dataanulacao = parts[2] + "-" + (parts[1]) + "-" + parts[0];
                $("#txtDataanulacao").val(dataanulacao);

                $("#txtDescricaoanulacao").val(descricaoanulacao);
                $("#txtValoranulacao").val(valoranulacao);

                //displays values to modal
                $(this).find("#DynamicModalLabel").html($("<b>Editar Anulação do Empenho: " + notaEmpenho + "</b>"))
                $('#btnanular').attr('data-id', movimentacaoId);
                $('#txtMovimentacaoId').attr('value', movimentacaoId);
            }).on("hide.bs.modal", function (event) {
                $(this).find("#modal_body").html("");
            });

        });

    </script>

    <script>

        // Botão APORTAR do Modal
        //=======================
        $("#btnAportar").click(function (e) {

            e.preventDefault();

            console.log("txtDescricao.val: (" + $("#txtDescricaoAporte").val() + ")");
            console.log("txtData.val: (" + $("#txtDescricaoAporte").val() + ")");
            console.log("txtValor.val: (" + $("#txtDescricaoAporte").val() + ")");

            if ($("#txtDataAporte").val() === "") {
                swal({
                    title: 'Atenção',
                    text: "A data do Aporte é obrigatória!",
                    icon: "error",
                    buttons: true,
                    dangerMode: true,
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            if ($("#txtDescricaoAporte").val() === "") {
                swal({
                    title: 'Atenção',
                    text: "A descrição do Aporte é obrigatória!",
                    icon: "error",
                    buttons: true,
                    dangerMode: true,
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            if ($("#txtValorAporte").val() === "") {
                swal({
                    title: 'Atenção',
                    text: "O valor do Aporte é obrigatório!",
                    icon: "error",
                    buttons: true,
                    dangerMode: true,
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            var valorAporte = $("#txtValorAporte").val();

            var i = 0;
            while ((i = valorAporte.indexOf(".", i)) != -1) {
                valorAporte = valorAporte.replace(".", "");
            }
            console.log("Valor: " + valorAporte);

            valorAporte = valorAporte.replace("R$", "");
            var EmpenhoMultaId = '@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId.ToString()';
            var objAporte = JSON.stringify({ "EmpenhoMultaId": EmpenhoMultaId , "MovimentacaoId": $('#txtMovimentacaoId').val(), "Descricao": $('#txtDescricaoAporte').val(), "Valor": valorAporte, "DataMovimentacao": $('#txtDataAporte').val(), "TipoMovimentacao": "A" })

            $.ajax({
                type: "post",
                url: "/api/Multa/EditarAporte",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: objAporte,

                success: function (data) {
                    toastr.success(data.message);
                    $('#tblAporte').DataTable().ajax.reload(null, false);
                    $("#modalAporte").hide();
                    location.reload();

                },
                error: function (data) {
                    alert('error');
                    console.log(data);
                }
            });
        });

        // Botão anular do Modal
        //=======================
        $("#btnAnular").click(function (e) {

            e.preventDefault();

            if ($("#txtDataanulacao").val() === "") {
                swal({
                    title: 'Atenção',
                    text: "A data da anulacao é obrigatória!",
                    icon: "error",
                    buttons: true,
                    dangerMode: true,
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            if ($("#txtDescricaoanulacao").val() === "") {
                swal({
                    title: 'Atenção',
                    text: "A descrição da anulacao é obrigatória!",
                    icon: "error",
                    buttons: true,
                    dangerMode: true,
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            if ($("#txtValoranulacao").val() === "") {
                swal({
                    title: 'Atenção',
                    text: "O valor da anulacao é obrigatório!",
                    icon: "error",
                    buttons: true,
                    dangerMode: true,
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            var valoranulacao = $("#txtValoranulacao").val();

            var i = 0;
            while ((i = valoranulacao.indexOf(".", i)) != -1) {
                valoranulacao = valoranulacao.replace(".", "");
            }

            valoranulacao = valoranulacao.replace("R$", "");
            var EmpenhoMultaId = '@Model.EmpenhoMultaObj.EmpenhoMulta.EmpenhoMultaId.ToString()';
            var objanulacao = JSON.stringify({ "EmpenhoMultaId": EmpenhoMultaId, "MovimentacaoId": $('#txtMovimentacaoId').val(), "Descricao": $('#txtDescricaoanulacao').val(), "Valor": valoranulacao, "DataMovimentacao": $('#txtDataanulacao').val(), "TipoMovimentacao": "G" })

            debugger;

            $.ajax({
                type: "post",
                url: "/api/Multa/EditarAnulacao",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: objanulacao,

                success: function (data) {
                    toastr.success(data.message);
                    $('#tblanulacao').DataTable().ajax.reload(null, false);
                    $("#modalanulacao").hide();
                    location.reload();

                },
                error: function (data) {
                    alert('error');
                    console.log(data);
                }
            });
        });


    </script>


    <script>
        function moeda(a, e, r, t) {
            let n = ""
                , h = j = 0
                , u = tamanho2 = 0
                , l = ajd2 = ""
                , o = window.Event ? t.which : t.keyCode;
            if (13 == o || 8 == o)
                return !0;
            if (n = String.fromCharCode(o),
                -1 == "0123456789".indexOf(n))
                return !1;
            for (u = a.value.length,
                h = 0; h < u && ("0" == a.value.charAt(h) || a.value.charAt(h) == r); h++)
                ;
            for (l = ""; h < u; h++)
                -1 != "0123456789".indexOf(a.value.charAt(h)) && (l += a.value.charAt(h));
            if (l += n,
                0 == (u = l.length) && (a.value = ""),
                1 == u && (a.value = "0" + r + "0" + l),
                2 == u && (a.value = "0" + r + l),
                u > 2) {
                for (ajd2 = "",
                    j = 0,
                    h = u - 3; h >= 0; h--)
                    3 == j && (ajd2 += e,
                        j = 0),
                        ajd2 += l.charAt(h),
                        j++;
                for (a.value = "",
                    tamanho2 = ajd2.length,
                    h = tamanho2 - 1; h >= 0; h--)
                    a.value += ajd2.charAt(h);
                a.value += r + l.substr(u - 2, u)
            }
            return !1
        }
    </script>



}